# Database 

## Mysql

This cluster provides a shared mysql instance. 

By using this [operator](https://github.com/kloeckner-i/db-operator), it is possible to create databases in a declarative way. Which is very useful

```YAML
--- 
# Sample Database
apiVersion: "kci.rocks/v1alpha1"
kind: "Database"
metadata:
  name: "my-app-db"
  namespace: "my-app-namespace"
spec:
  secretName: my-app-db-credentials
  instance: mysql-shared # This his the name of mysql instance available in the cluster
  deletionProtected: false # Protection to not delete database when custom resource is deleted
  backup:
    enable: false # turn it to true when you want to use back up feature. currently only support postgres
    cron: "0 0 * * *"
```

After successful `Database` creation, you must be able to get a secret named like `my-app-db-credentials`.

```
$ kubectl get secret my-app-db-credentials
```

It contains credentials to connect to the database generated by operator.

```YAML
apiVersion: v1
kind: Secret
metadata:
  labels:
    created-by: db-operator
  name: my-app-db-credentials
type: Opaque
data:
  DB: << base64 encoded database name >>
  PASSWORD: << base64 encoded password >>
  USER: << base64 encoded user name >>
```

You should be able to get configmap with same name as secret like `my-app-db-credentials`.

```
$ kubectl get configmap my-app-db-credentials
```

It contains connection information for database server access.

```YAML
apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    created-by: db-operator
  name: my-app-db-credentials
data:
  DB_CONN: << database server address >>
  DB_PORT: << database server port >>
  DB_PUBLIC_IP: << database server public ip >>
  ...
```
These values can then be passed as environment variables to a pod allowing an application to connect.

```YAML
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: my-app
  template:
    metadata:
      labels:
        app: my-app
    spec:
      containers:
      - name: my-app
        image: "appimage:latest"
        imagePullPolicy: Always
        env:
        - name: MYSQL_USERNAME
          valueFrom:
          secretKeyRef:
              key: USER
              name: my-app-db-credentials # has to be same with spec.secretName of Database custom resource
        - name: MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              key: PASSWORD
              name: my-app-db-credentials
        - name: MYSQL_DB
          valueFrom:
            secretKeyRef:
              key: DB
              name: my-app-db-credentials # has to be same with spec.secretName of Database custom resource
        - name: MYSQL_HOST
          valueFrom:
            configMapKeyRef:
              key: DB_CONN
              name: my-app-db-credentials # has to be same with spec.secretName of Database custom resource
        - name: MYSQL_PORT
          valueFrom:
            configMapKeyRef:
              key: DB_PORT
              name: my-app-db-credentials # has to be same with spec.secretName of Database custom resource
```